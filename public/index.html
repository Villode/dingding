<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>叮叮博客</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <style>
        .like-icon {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            color: #f472b6;
        }
        
        .like-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .like-button:hover {
            transform: scale(1.05);
        }
        .like-button:active {
            transform: scale(0.95);
        }
        .like-animation {
            animation: likeEffect 0.5s ease-in-out;
        }
        @keyframes likeEffect {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-white shadow">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <h1 class="text-3xl font-bold text-gray-900">叮叮博客</h1>
        </div>
    </header>
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0">
            <div id="main-content">
                <!-- 主页文章列表 -->
                <div id="home-content">
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">最新文章</h2>
                        <div id="posts-container" class="space-y-4">
                            <p class="text-gray-500">加载中...</p>
                        </div>
                    </div>
                </div>
                
                <!-- 文章详情页，默认隐藏 -->
                <div id="article-content" class="hidden">
                    <div class="mb-4">
                        <button id="back-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            返回首页
                        </button>
                    </div>
                    <div id="article-container" class="bg-white shadow overflow-hidden rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h2 class="text-2xl font-bold mb-4 text-gray-500">加载中...</h2>
                            <div class="animate-pulse">
                                <div class="h-4 bg-gray-200 rounded w-1/4 mb-6"></div>
                                <div class="h-4 bg-gray-200 rounded w-full mb-2"></div>
                                <div class="h-4 bg-gray-200 rounded w-full mb-2"></div>
                                <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <footer class="bg-white border-t mt-12 py-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <p class="text-center text-gray-500 text-sm">
                &copy; 2023 叮叮博客 | 基于 Cloudflare Pages 构建
            </p>
        </div>
    </footer>

    <script>
        // 全局变量存储当前视图状态和文章ID
        let currentState = 'home';
        let currentArticleId = null;
        
        // 初始化时检查URL
        document.addEventListener('DOMContentLoaded', async () => {
            const path = window.location.pathname;
            if (path.startsWith('/post/')) {
                const postId = path.split('/').pop();
                if (postId) {
                    await loadArticle(postId);
                    return;
                }
            }
            
            // 默认加载文章列表
            await loadArticleList();
        });
        
        // 加载文章列表
        async function loadArticleList() {
            try {
                const response = await fetch('/api/posts');
                const posts = await response.json();
                
                const postsContainer = document.getElementById('posts-container');
                
                if (posts && posts.length > 0) {
                    postsContainer.innerHTML = '';
                    
                    // 获取所有文章的点赞数
                    const likesPromises = posts.map(post => 
                        fetch(`/api/post/like/${post.id}`)
                            .then(res => res.ok ? res.json() : {likes: 0})
                            .then(data => ({id: post.id, likes: data.likes}))
                            .catch(() => ({id: post.id, likes: 0}))
                    );
                    
                    const likesResults = await Promise.all(likesPromises);
                    const likesMap = {};
                    likesResults.forEach(item => {
                        likesMap[item.id] = item.likes;
                    });
                    
                    posts.forEach(post => {
                        const postDate = new Date(post.published_at).toLocaleDateString('zh-CN');
                        const likeCount = likesMap[post.id] || 0;
                        
                        const postElement = document.createElement('div');
                        postElement.className = 'bg-white p-4 rounded shadow';
                        postElement.innerHTML = `
                            <h3 class="text-xl font-bold">
                                <a href="#" class="text-blue-600 hover:text-blue-800 article-link" data-id="${post.id}">
                                    ${post.title}
                                </a>
                            </h3>
                            <p class="text-gray-600 mt-2">${post.summary || '无摘要'}</p>
                            <div class="flex justify-between items-center mt-2">
                                <p class="text-gray-400 text-sm">发布于 ${postDate}</p>
                                <span class="like-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="${likeCount > 0 ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                    </svg>
                                    <span>${likeCount}</span>
                                </span>
                            </div>
                        `;
                        
                        postsContainer.appendChild(postElement);
                    });
                    
                    // 添加文章链接点击事件
                    document.querySelectorAll('.article-link').forEach(link => {
                        link.addEventListener('click', function(e) {
                            e.preventDefault();
                            const articleId = this.getAttribute('data-id');
                            navigateToArticle(articleId);
                        });
                    });
                } else {
                    postsContainer.innerHTML = '<p class="text-gray-500">暂无文章</p>';
                }
                
                // 显示首页，隐藏文章详情页
                showHomeView();
            } catch (error) {
                console.error('获取文章失败:', error);
                document.getElementById('posts-container').innerHTML = 
                    '<p class="text-red-500">获取文章列表失败，请稍后再试</p>';
            }
        }
        
        // 加载文章详情
        async function loadArticle(articleId) {
            try {
                // 显示文章详情页，隐藏首页
                showArticleView();
                
                // 更新URL但不重新加载页面
                history.pushState({articleId}, '', `/post/${articleId}`);
                currentArticleId = articleId;
                
                // 获取文章数据
                const response = await fetch(`/api/post/${articleId}`);
                
                if (!response.ok) {
                    throw new Error(`获取文章失败: ${response.status}`);
                }
                
                const article = await response.json();
                
                // 更新页面标题
                document.title = `${article.title} - 叮叮博客`;
                
                // 更新文章内容
                const articleContainer = document.getElementById('article-container');
                
                // 格式化日期
                const publishDate = new Date(article.published_at);
                const formattedDate = publishDate.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                articleContainer.innerHTML = `
                    <div class="px-4 py-5 sm:p-6">
                        <h2 class="text-3xl font-bold mb-4 text-gray-900">${article.title}</h2>
                        <p class="text-gray-500 mb-6">${formattedDate}</p>
                        <div class="prose max-w-none">
                            ${article.content}
                        </div>
                        
                        <!-- 点赞按钮区域 -->
                        <div class="mt-8 flex justify-center">
                            <button id="like-button" class="like-button bg-pink-50 hover:bg-pink-100 text-pink-600 font-medium py-2 px-6 rounded-full shadow-sm flex items-center gap-2">
                                <svg id="like-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-all">
                                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                </svg>
                                <span id="like-count">0</span> 次点赞
                            </button>
                        </div>
                    </div>
                `;
                
                // 获取并显示点赞数
                try {
                    const likeResponse = await fetch(`/api/post/like/${articleId}`);
                    const likeData = await likeResponse.json();
                    
                    if (!likeResponse.ok) {
                        throw new Error(likeData.error || likeData.message || '获取点赞数失败');
                    }
                    
                    document.getElementById('like-count').textContent = likeData.likes;
                    if (likeData.likes > 0) {
                        document.getElementById('like-icon').setAttribute('fill', '#ec4899');
                    }
                } catch (error) {
                    console.error('获取点赞数据失败:', error);
                    document.getElementById('like-count').textContent = '点赞功能不可用';
                    // 禁用点赞按钮
                    document.getElementById('like-button').disabled = true;
                    document.getElementById('like-button').title = error.message || '点赞功能暂时不可用';
                }
                
                // 绑定点赞按钮事件
                document.getElementById('like-button').addEventListener('click', async () => {
                    try {
                        const likeIcon = document.getElementById('like-icon');
                        const likeButton = document.getElementById('like-button');
                        
                        // 禁用按钮，防止重复点击
                        likeButton.disabled = true;
                        
                        // 动画效果
                        likeIcon.classList.add('like-animation');
                        setTimeout(() => likeIcon.classList.remove('like-animation'), 500);
                        
                        // 发送点赞请求
                        const response = await fetch(`/api/post/like/${articleId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const data = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(data.error || data.message || '点赞失败');
                        }
                        
                        // 更新点赞数
                        document.getElementById('like-count').textContent = data.likes;
                        
                        // 填充心形
                        likeIcon.setAttribute('fill', '#ec4899');
                        
                        // 启用按钮
                        setTimeout(() => {
                            likeButton.disabled = false;
                        }, 1000);
                    } catch (error) {
                        console.error('点赞失败:', error);
                        alert(`点赞失败: ${error.message || '请稍后再试'}`);
                        
                        // 重置按钮状态
                        document.getElementById('like-button').disabled = false;
                    }
                });
            } catch (error) {
                console.error('加载文章失败:', error);
                
                const articleContainer = document.getElementById('article-container');
                articleContainer.innerHTML = `
                    <div class="px-4 py-5 sm:p-6">
                        <h2 class="text-2xl font-bold mb-4 text-red-500">加载文章失败</h2>
                        <p class="text-gray-700">
                            无法加载文章内容，请返回<button class="text-blue-500 hover:underline" id="back-to-home">首页</button>查看其他文章。
                        </p>
                        <p class="text-gray-500 mt-2">错误详情: ${error.message}</p>
                    </div>
                `;
                
                document.getElementById('back-to-home').addEventListener('click', navigateToHome);
            }
        }
        
        // 显示首页视图
        function showHomeView() {
            document.getElementById('home-content').classList.remove('hidden');
            document.getElementById('article-content').classList.add('hidden');
            document.title = '叮叮博客';
            currentState = 'home';
        }
        
        // 显示文章详情视图
        function showArticleView() {
            document.getElementById('home-content').classList.add('hidden');
            document.getElementById('article-content').classList.remove('hidden');
            currentState = 'article';
        }
        
        // 导航到文章页面
        function navigateToArticle(articleId) {
            loadArticle(articleId);
        }
        
        // 导航到首页
        function navigateToHome() {
            history.pushState({}, '', '/');
            currentArticleId = null;
            showHomeView();
        }
        
        // 处理返回按钮点击
        document.getElementById('back-button').addEventListener('click', navigateToHome);
        
        // 处理浏览器前进/后退按钮
        window.addEventListener('popstate', function(event) {
            const path = window.location.pathname;
            if (path === '/' || path === '') {
                showHomeView();
            } else if (path.startsWith('/post/')) {
                const postId = path.split('/').pop();
                if (postId) {
                    loadArticle(postId);
                }
            }
        });
    </script>
</body>
</html> 